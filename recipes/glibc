#!/bin/bash

name=glibc
version=2.42
tarball_url="https://ftp.gnu.org/gnu/glibc/glibc-${version}.tar.xz"
tarball_blake2b="6ffabfe7942034a5a4fb5097679cb47bc3431eb2a3864af07cea0cb6aa5db63fbaf6f026b3c9299e00268058a6762eb21e92499f012d552ed87d65c7ffbd0bbe"
revision=2
hostdeps="gcc-bootstrap pkgconf"
deps="linux-headers"

configure() {
    # glibc handles fortify internally via --enable-fortify-source.
    # Remove any -D_FORTIFY_SOURCE from TARGET_CFLAGS to avoid conflicts.
    TARGET_CFLAGS="${TARGET_CFLAGS//-Wp,-D_FORTIFY_SOURCE=?/}"

    echo "slibdir=${prefix}/lib" >>configparms
    echo "rtlddir=${prefix}/lib" >>configparms
    echo "sbindir=${prefix}/bin" >>configparms
    echo "rootsbindir=${prefix}/bin" >>configparms

    autotools_configure \
        --with-headers="${sysroot_dir}${prefix}"/include \
        --enable-bind-now \
        --enable-cet \
        --enable-fortify-source \
        --enable-stack-protector=strong \
        --disable-nscd \
        --disable-profile \
        --disable-timezone-tools \
        --disable-werror
}

build() {
    make -j${parallelism}
}

package() {
    DESTDIR="${dest_dir}" make install

    cp -v "${base_dir}"/build-support/glibc/locale-gen "${dest_dir}${prefix}"/bin/
    mkdir -p "${dest_dir}${prefix}/lib/locale"

    # Create /etc/locale.gen
    cat <<EOF >"${dest_dir}/etc/locale.gen"
# Configuration file for locale-gen
#
# Lists locales that will be generated by the locale-gen command
#
# Each line is of the form:
#
#     <locale> <charset>
#
#  where <locale> is one of the locales given in /usr/share/i18n/locales
#  and <charset> is one of the character sets listed in /usr/share/i18n/charmaps
#
#  The locale-gen command will generate all the locales placing them in /usr/lib/locale.
#
#  A list of supported locales is given in /usr/share/i18n/SUPPORTED
#  and is included in this file. Uncomment the needed locales below.
#

EOF
    sed -e '1,3d' -e 's|/| |g' -e 's|\\| |g' -e 's|^|#|g' "${source_dir}/localedata/SUPPORTED" >>"${dest_dir}/etc/locale.gen"
    sed -i '/#C\.UTF-8 /d' "${dest_dir}/etc/locale.gen"

    # Install the SUPPORTED file for reference
    sed -e '1,3d' -e 's|/| |g' -e 's| \\||g' "${source_dir}/localedata/SUPPORTED" > "${dest_dir}${prefix}/share/i18n/SUPPORTED"

    # Install C.UTF-8 locale by default
        I18NPATH="${dest_dir}${prefix}/share/locale" \
    localedef -i C -f UTF-8 --prefix="${dest_dir}" C.UTF-8
}
