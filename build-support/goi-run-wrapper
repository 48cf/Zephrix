#!/bin/bash

temp="$(mktemp)"
trap 'rm -f "${temp}"' EXIT

if ! readelf -h "$1" &>/dev/null; then
    cp -fp "$1" "${temp}"

    # Patch the script to use the run wrapper
    if grep -q 'Generated by libtool' "${temp}"; then
        sed -E 's|(exec) ("\$progdir/\$program" \$)|\1 "'${GI_CROSS_LAUNCHER}'" \2|g' -i "${temp}"
    fi

    "${temp}" "${@:2}"
    exit_code=$?
else
    bindir=$(dirname "$1")
    rpath=$(patchelf --print-rpath "$1")

    if ! [ -z "$rpath" ]; then
        # Split rpath by ':'
        IFS=':' read -ra rpath_array <<< "$rpath"

        # Build new rpath array by replacing each entry with its absolute path
        for i in "${!rpath_array[@]}"; do
            if [[ "${rpath_array[$i]}" == *"\$ORIGIN"* ]]; then
                # Replace $ORIGIN with the directory of the binary
                rpath_array[$i]="${rpath_array[$i]//\$ORIGIN/$bindir}"
            else
                rpath_array[$i]="$(realpath "${rpath_array[$i]}")"
            fi
        done

        # Join the array back into a string
        rpath=$(IFS=:; echo "${rpath_array[*]}")
        abs_rpath="${rpath}"
    else
        abs_rpath=$(dirname "$(realpath "$1")")
    fi

    cp -fp "$1" "${temp}"
    patchelf --set-rpath "${abs_rpath}" "${temp}"

    LD_LIBRARY_PATH="${LD_LIBRARY_PATH}:${RUN_WRAPPER_LD_LIBRARY_PATH}" "${temp}" "${@:2}"
    exit_code=$?
fi

exit ${exit_code}
